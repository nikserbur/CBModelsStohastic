# CB_models_stohastic — Стохастическое моделирование ставок ЦБ РФ

Данный проект представляет комплексное исследование стохастического моделирования ключевых процентных ставок центральных банков с применением распределений с жирными хвостами (fat tails). Проект интегрирует современные подходы к анализу tail risks, основанные на исследованиях Fed (2024), BIS, NY Fed и методологии Талеба.

**Разработчик:** Бураков Никита Сергеевич  
**Версия:** 2.1 (Масштабируемая методология)  
**Дата:** 2025-01-27

### Для запуска всего интегрированного проекта:
```r
# Установка зависимостей и подключение всех библиотек
source("1.R/9.libraries.r")

# Запуск полного интегрированного анализа (автоматически интегрирует все компоненты)
source("1.R/Main.R")
```

### Для запуска тестирования системы:
```r
# Подключение функций
source("1.R/8.SourceAll.R")

# Запуск комплексного тестирования
test_results <- RunComprehensiveTests()
```


## Архитектура и развитие модели

### Текущая структура файлов:
```
CB_models_stohastic/
├── 1.R/
│   ├── 1.functions/
│   │   └── all_fun.R                   # Объединенный файл всех функций
│   ├── 3.dist_bust.R                   # Анализ распределений жирных хвостов
│   ├── 4.LmR2BoostingStohastic.R      # R² коррекция для fat tails
│   ├── 8.SourceAll.R                   # Централизованная загрузка
│   ├── 9.libraries.r                   # Библиотеки
│   └── Main.R                          # Основной скрипт
├── 2.Cpp/
│   └── FastMonteCarlo.cpp              # Rcpp оптимизации
├── 3.Data/                             # Данные ЦБ и результаты
└── README.md                           # Документация
```

### Интегрированная архитектура с Rcpp:

**Main.R** работает как полностью интегрированная система с Rcpp оптимизациями:

1. **Анализ жирных хвостов** → Калибровка параметров распределений
2. **HAR волатильность** → Динамическая модуляция стохастических шоков **+ Rcpp ускорение**
3. **HMM режимы** → Структурные сдвиги параметров **+ Rcpp ускорение**
4. **Gradient Boosting** → Оптимальное распределение остатков
5. **Taleb R² + Shapley** → Веса важности переменных в модели
6. **Monte Carlo симуляции** → **+ Rcpp ускорение**

## Rcpp оптимизации

### Функции с Rcpp поддержкой:
```r
# Оптимизированный Monte Carlo
OptimizedMonteCarlo(n_simulations = 10000, horizon = 12, parameters)

# Ускоренные HAR расчеты
FastHARCalculation(volatility_series)

# Оптимизированные HMM алгоритмы
FastHMMForwardBackward(observations, hmm_params)

# Компиляция оптимизаций
CompileRcppOptimizations()
```

Main.R (Полная интеграция)
```
├── 8.SourceAll.R → 9.libraries.r + все функции
├── PrepareMainData() → Поддержка новых данных
├── ЭТАП 1: AnalyzeFatTails() → tail_parameters для калибровки
├── ЭТАП 2: HAR модель → har_volatility как динамическая компонента
├── ЭТАП 3: HMM обучение → regime факторы для структурных сдвигов
├── ЭТАП 4: Gradient Boosting → alpha_corrected с учетом хвостов
├── ЭТАП 5: Taleb R² + Shapley → shapley_weights для модели
├── ЭТАП 6: IntegratedStochasticModel() → Все методы синхронно
├── Диагностика интеграции → Метрики влияния компонентов
├── AddNewDataToModel() → Расширение модели новыми переменными
└── Визуализация интегрированных результатов
```
**Примечание:** Все параметры модели обучаются на реальных данных ЦБ РФ. Каждый метод напрямую влияет на итоговый прогноз.

### Направления развития модели

#### 1. Расширение макроэкономических переменных
Текущая модель фокусируется на основных параметрах (инфляция, ВВП), но может быть расширена для прогнозирования:

**Дополнительные макроэкономические индикаторы:**
- **Кредитный импульс** - динамика кредитования и его влияние на монетарную политику
- **Ожидаемая инфляция** - инфляционные ожидания населения и бизнеса
- **Валютный курс** - влияние курсовых колебаний на инфляционное давление
- **Цены на сырье** - нефть, газ, металлы как факторы инфляции
- **Фискальная политика** - бюджетные расходы и их влияние на экономику
- **Внешнеторговый баланс** - экспорт/импорт и их влияние на ликвидность
- **Рынок труда** - безработица, зарплаты, производительность труда
- **Финансовые условия** - спреды по кредитам, условия кредитования

**Методология расширения:**
```r
# Пример добавления новых переменных
extended_model <- lm(
  ruonia_rate ~ I(lag(ruonia_rate, 1)) + 
                inflation_deviation + gdp_gap +
                credit_impulse + expected_inflation +
                exchange_rate + oil_prices +
                fiscal_balance + trade_balance +
                unemployment_rate + wage_growth +
                financial_conditions,
  data = train_data_with_regimes
)
```

#### 2. Улучшение визуализации и анализа
- **Интерактивные сети марковских цепей** (visNetwork) - для анализа переходов между режимами
- **Тепловые карты матриц переходов** - для визуализации вероятностей смены режимов
- **Белый фон для графиков** - улучшенная читаемость и презентабельность
- **Анимации эволюции режимов** - динамическое отображение изменений

#### 3. Интеграция дополнительных методов
- **VAR модели** - для учета взаимосвязей между переменными
- **Cointegration анализ** - для долгосрочных равновесных отношений
- **Granger causality** - для определения причинно-следственных связей
- **Structural breaks** - для выявления структурных изменений

## Архитектура системы

Разработанная система представляет собой многоуровневую архитектуру для стохастического моделирования процентных ставок, где каждый компонент решает специфические задачи, но все они интегрированы в единую экосистему:

```mermaid
%%{init: {'theme':'dark', 'themeVariables': {'primaryColor': '#ff7f00', 'primaryTextColor': '#ffffff', 'primaryBorderColor': '#ff7f00', 'lineColor': '#ffffff', 'secondaryColor': '#1f1f1f', 'tertiaryColor': '#2f2f2f', 'background': '#1f1f1f', 'mainBkg': '#2f2f2f', 'secondBkg': '#3f3f3f', 'tertiaryBkg': '#4f4f4f'}}}%%
graph TD
    A["Входные данные<br/>Инфляция, ВВП, Кредитный импульс"] --> B["Анализ жирных хвостов<br/>α-stable, t-distribution"]
    A --> C["HAR Модель волатильности<br/>RV(t) = β₀ + β₁RV(t-1) + β₂RV(t-1,t-5) + β₃RV(t-1,t-22)"]
    A --> D["HMM Режимы<br/>Нормальный/Кризисный/Инфляционный"]
    
    B --> E["Gradient Boosting<br/>Выбор распределения"]
    C --> F["Стохастическая модель Тейлора<br/>dr(t) = α(π-π*) + β(y-y*) + σdW + γdJ"]
    D --> F
    E --> F
    
    F --> G["Monte Carlo симуляции<br/>N=10,000 путей"]
    G --> H["Метрики качества<br/>VaR, CVaR, CRPS, PIT"]
    H --> I["Taleb R² коррекция<br/>R² = a²(α-2)/(a²(α-2) + α)"]
    
    I --> J["Итоговый прогноз<br/>Fan chart с доверительными интервалами"]
    
    K["Rcpp оптимизации<br/>FastMonteCarlo.cpp"] --> G
    K --> C
    K --> D
```

## Стохастические процессы с жирными хвостами

### Базовая стохастическая дифференциальная модель

В основе нашего подхода лежит расширенное стохастическое дифференциальное уравнение, которое включает несколько типов случайных процессов для более точного моделирования экстремальных событий:

```
dr(t) = μ(r,t)dt + σ(r,t)dW(t) + γ(r,t)dJ(t) + δ(r,t)dN(t)
```

**где:**
- `r(t)` — процентная ставка в момент времени t
- `μ(r,t)` — функция drift (детерминированный тренд)
- `σ(r,t)` — функция диффузии (волатильность)
- `dW(t)` — приращение винеровского процесса (гауссовские шоки)
- `γ(r,t)` — интенсивность α-stable скачков
- `dJ(t)` — приращение α-stable процесса (жирные хвосты)
- `δ(r,t)` — интенсивность пуассоновских шоков
- `dN(t)` — приращение составного пуассоновского процесса (редкие события)

```mermaid
%%{init: {'theme':'dark', 'themeVariables': {'primaryColor': '#ff7f00', 'primaryTextColor': '#ffffff', 'primaryBorderColor': '#ff7f00', 'lineColor': '#ffffff', 'secondaryColor': '#1f1f1f', 'tertiaryColor': '#2f2f2f', 'background': '#1f1f1f', 'mainBkg': '#2f2f2f', 'secondBkg': '#3f3f3f', 'tertiaryBkg': '#4f4f4f'}}}%%
graph TD
    A["Базовая SDE<br/>dr(t) = μ(r,t)dt + σ(r,t)dW(t)"] --> B["Расширенная SDE<br/>dr(t) = μ(r,t)dt + σ(r,t)dW(t) + γ(r,t)dJ(t) + δ(r,t)dN(t)"]
    
    B --> C["Drift: μ(r,t) = κ(θ(t) - r(t))<br/>где θ(t) = r* + α(π-π*) + β(y-y*)"]
    B --> D["Диффузия: σ(r,t) = σ₀√(1 + λ|r-r*|)<br/>HAR волатильность ⚡ Rcpp"]
    B --> E["α-stable скачки: J(t)<br/>dJ ~ S(α=1.8, β=0, γ, δ=0)"]
    B --> F["Пуассоновские шоки: N(t)<br/>dN ~ Poisson(λ=0.05)"]
    
    C --> G["Дискретизация <br/>r(t+Δt) = r(t) + μΔt + σ√(Δt)Z + γΔJ + δΔN"]
    D --> G
    E --> G
    F --> G
    
    G --> H["Monte Carlo br/>N=10,000 симуляций"]
    H --> I["Квантили<br/>q₀.₀₅, q₀.₂₅, q₀.₅, q₀.₇₅, q₀.₉₅"]
    
    I --> J["Метрики качества<br/>VaR = q₀.₀₅<br/>CVaR = E[r|r < q₀.₀₅]<br/>CRPS = ∫(F(x) - 𝟙(x≥y))²dx"]
```

**Drift функция** представляет собой расширенное правило Тейлора: `μ(r,t) = κ(θ(t) - r(t))`, где:
- `κ` — скорость возврата к равновесию
- `θ(t)` — целевая ставка
- `r*` — нейтральная ставка
- `α` — реакция на инфляцию
- `π(t)` — текущая инфляция
- `π*` — цель по инфляции
- `β` — реакция на выпуск
- `y(t)` — текущий выпуск
- `y*` — потенциальный выпуск

**Диффузионная компонента** использует HAR волатильность: `σ(r,t) = σ₀√HAR(t) × √(1 + λ|r(t) - r*|)`, где:
- `σ₀` — базовая волатильность
- `HAR(t)` — гетерогенная авторегрессивная волатильность
- `λ` — параметр нелинейности
- `r(t) - r*` — отклонение от нейтральной ставки

**α-stable скачки** моделируют экстремальные события: `dJ(t) ~ S(α, β, γ, δ)`, где:
- `α = 1.8` — параметр хвостов (1 < α < 2 для жирных хвостов)
- `β = 0` — параметр асимметрии (-1 ≤ β ≤ 1)
- `γ` — параметр масштаба (γ > 0)
- `δ = 0` — параметр сдвига

**Пуассоновские шоки** представляют редкие структурные разрывы: `dN(t) ~ Compound Poisson(λ, F)`, где:
- `λ = 0.05` — интенсивность событий (среднее количество событий в единицу времени)
- `F` — распределение размера скачка

## Режимы денежно-кредитной политики через HMM

Скрытые марковские цепи позволяют моделировать различные режимы экономики, каждый из которых характеризуется своими параметрами процентных ставок:

```mermaid
%%{init: {'theme':'dark', 'themeVariables': {'primaryColor': '#ff7f00', 'primaryTextColor': '#ffffff', 'primaryBorderColor': '#ff7f00', 'lineColor': '#ffffff', 'secondaryColor': '#1f1f1f', 'tertiaryColor': '#2f2f2f', 'background': '#1f1f1f', 'mainBkg': '#2f2f2f', 'secondBkg': '#3f3f3f', 'tertiaryBkg': '#4f4f4f'}}}%%
stateDiagram-v2
    [*] --> Normal
    Normal --> Normal : P₁₁=0.85<br/>Стабильная<br/>экономика
    Normal --> Crisis : P₁₂=0.10<br/>Внешний<br/>шок
    Normal --> Inflationary : P₁₃=0.05<br/>Перегрев<br/>экономики
    
    Crisis --> Crisis : P₂₂=0.70<br/>Продолжение<br/>кризиса
    Crisis --> Normal : P₂₁=0.20<br/>Стабилизация<br/>экономики
    Crisis --> Inflationary : P₂₃=0.10<br/>Инфляционный<br/>всплеск
    
    Inflationary --> Inflationary : P₃₃=0.70<br/>Инфляционная<br/>инерция
    Inflationary --> Normal : P₃₁=0.15<br/>Успешная<br/>дезинфляция
    Inflationary --> Crisis : P₃₂=0.15<br/>Жесткая<br/>политика
    
    Normal : μ₁ = 6.0%<br/>σ₁ = 1.0%<br/>Низкие ставки
    Crisis : μ₂ = 8.0%<br/>σ₂ = 2.0%<br/>Высокая волатильность
    Inflationary : μ₃ = 12.0%<br/>σ₃ = 1.5%<br/>Высокие ставки
```

Математически система описывается матрицей переходов `P = [0.85 0.10 0.05; 0.20 0.70 0.10; 0.15 0.15 0.70]` и вероятностями эмиссии `p(r(t)|S(t)=k) = N(r(t); μₖ, σₖ²)`. 

**Forward-Backward алгоритм:** `α(t,k) = p(r(t)|S(t)=k) × Σⱼ α(t-1,j) × P(j,k)` и `β(t,k) = Σⱼ β(t+1,j) × P(k,j) × p(r(t+1)|S(t+1)=j)`, где:
- `α(t,k)` — прямая вероятность (вероятность наблюдений до момента t и состояния k в момент t)
- `β(t,k)` — обратная вероятность (вероятность наблюдений после момента t при состоянии k в момент t)
- `P(j,k)` — вероятность перехода из состояния j в состояние k
- `p(r(t)|S(t)=k)` — вероятность наблюдения r(t) при состоянии k

Вероятности состояний: `P(S(t)=k|r₁:T) = α(t,k) × β(t,k) / Σⱼ α(t,j) × β(t,j)`

## HAR модели волатильности

Heterogeneous Autoregressive модели учитывают различные временные горизонты участников рынка, что критично для точного прогнозирования волатильности процентных ставок:

```mermaid
%%{init: {'theme':'dark', 'themeVariables': {'primaryColor': '#ff7f00', 'primaryTextColor': '#ffffff', 'primaryBorderColor': '#ff7f00', 'lineColor': '#ffffff', 'secondaryColor': '#1f1f1f', 'tertiaryColor': '#2f2f2f', 'background': '#1f1f1f', 'mainBkg': '#2f2f2f', 'secondBkg': '#3f3f3f', 'tertiaryBkg': '#4f4f4f'}}}%%
graph LR
    A["Дневная<br/>волатильность<br/>RV(t-1)"] --> D["HAR Модель<br/>RV(t) = β₀ + β₁RV(t-1) + β₂RV(t-1,t-5) + β₃RV(t-1,t-22)"]
    B["Недельная<br/>волатильность<br/>RV(t-1,t-5)"] --> D
    C["Месячная<br/>волатильность<br/>RV(t-1,t-22)"] --> D
    
    D --> E["Прогноз<br/>волатильности<br/>на t+1"]
    D --> F["Остатки<br/>для анализа<br/>жирных хвостов"]
    
    F --> G["α-stable<br/>распределение<br/>α = 1.8"]
    G --> H["Шоки<br/>волатильности<br/>с жирными хвостами"]
    
    E --> I["Стохастическая<br/>компонента<br/>σ(t+1)"]
    H --> I
    
    I --> J["Итоговая<br/>волатильность<br/>процентных ставок"]
```

Основная модель `RV(t) = β₀ + β₁RV^(d)(t-1) + β₂RV^(w)(t-1) + β₃RV^(m)(t-1) + ε(t)` включает временные компоненты:
- `RV(t)` — реализованная волатильность в момент t
- `β₀` — константа
- `β₁` — коэффициент дневной компоненты
- `RV^(d)(t-1) = RV(t-1)` — дневная волатильность
- `β₂` — коэффициент недельной компоненты  
- `RV^(w)(t-1) = 1/5 × Σᵢ₌₁⁵ RV(t-i+1)` — недельная волатильность (среднее за 5 дней)
- `β₃` — коэффициент месячной компоненты
- `RV^(m)(t-1) = 1/22 × Σᵢ₌₁²² RV(t-i+1)` — месячная волатильность (среднее за 22 дня)
- `ε(t)` — случайная ошибка

Прогнозирование: `RV(t+h) = β₀ + β₁RV^(d)(t+h-1) + β₂RV^(w)(t+h-1) + β₃RV^(m)(t+h-1)`, где h — горизонт прогнозирования.

## Taleb R² коррекция для жирных хвостов

При работе с распределениями с жирными хвостами стандартный R² может давать завышенные оценки качества модели. Методология Талеба предлагает точные формулы коррекции:

**Стандартный R²:** `R²ₛₜd = 1 - SS_res/SS_tot = 1 - Σε²ᵢ/Σ(yᵢ-ȳ)²`, где:
- `SS_res = Σε²ᵢ` — сумма квадратов остатков
- `SS_tot = Σ(yᵢ-ȳ)²` — общая сумма квадратов
- `εᵢ` — остаток для i-го наблюдения
- `yᵢ` — фактическое значение
- `ȳ` — среднее значение

**Taleb точная формула** для t-распределения: `R²ₜₐₗₑᵦ = a²(α-2)/(a²(α-2) + α)`, где:
- `a² = Var(ŷ)/Var(ε)` — отношение дисперсии прогнозов к дисперсии остатков
- `α` — параметр степеней свободы t-распределения
- `E[ε²] = α/(α-2)` — ожидаемая дисперсия для t-распределения при α > 2

**MLE коррекция:** `R²ₘₗₑ = 1 - SS_res × (α/(α-2))/SS_tot`, где:
- `α/(α-2)` — коррекционный множитель для t-распределения

**Shapley декомпозиция** для важности переменных: `R²ₛₕₐₚₗₑy = Σᵢ φᵢ(R²)`, где:
- `φᵢ(R²)` — вклад i-й переменной по Shapley
- `φᵢ(R²) = 1/p! × Σ_S⊆N\{i} [R²(S∪{i}) - R²(S)]`
- `p` — количество переменных
- `S` — подмножество переменных не включающее i
- `N` — множество всех переменных

## Gradient Boosting для выбора распределений

Адаптивный выбор оптимального распределения происходит через градиентный бустинг с функцией потерь `L(θ) = -Σᵢ₌₁ⁿ log p(yᵢ|xᵢ, θ)`, где:
- `L(θ)` — функция потерь (отрицательная логарифмическая правдоподобность)
- `θ` — параметры распределения
- `p(yᵢ|xᵢ, θ)` — плотность вероятности наблюдения yᵢ при заданных xᵢ и θ
- `n` — размер выборки

Обновление весов: `w^(t+1) = w^(t) × exp(-η × ∇L(θ^(t)))`, где:
- `w^(t)` — веса на итерации t
- `η` — скорость обучения
- `∇L(θ^(t))` — градиент функции потерь

Финальная модель: `p(y|x) = Σₖ₌₁ᴷ wₖ × pₖ(y|x, θₖ)`, где:
- `K` — количество распределений {Normal, t-dist, α-stable, GED}
- `wₖ` — вес k-го распределения
- `pₖ(y|x, θₖ)` — k-е распределение с параметрами θₖ

## Метрики качества

**Value at Risk (VaR)** на уровне α: `VaRₐ = inf{x : P(L ≤ x) ≥ α}`, где:
- `L` — потери (убытки)
- `α` — уровень доверия (например, 0.05 для 5%)

**Conditional VaR (Expected Shortfall):** `CVaRₐ = E[L | L ≤ VaRₐ]`, где:
- `E[L | L ≤ VaRₐ]` — условное математическое ожидание потерь при превышении VaR

**Continuous Ranked Probability Score (CRPS)** для непрерывных распределений: 
`CRPS(F,y) = ∫_{-∞}^{∞} (F(x) - 𝟙{x ≥ y})² dx`, где:
- `F(x)` — кумулятивная функция распределения прогноза
- `𝟙{x ≥ y}` — индикаторная функция (1 если x ≥ y, иначе 0)
- `y` — фактическое наблюдение

Для выборочных распределений: `CRPS = 1/n × Σᵢ₌₁ⁿ |xᵢ - y| - 1/(2n²) × Σᵢ₌₁ⁿ Σⱼ₌₁ⁿ |xᵢ - xⱼ|`, где:
- `xᵢ, xⱼ` — элементы прогнозной выборки
- `n` — размер прогнозной выборки

**Probability Integral Transform (PIT):** `PIT = F(y|x)`, где:
- `F` — прогнозное кумулятивное распределение
- `y` — реализованное значение
- Идеальная калибровка: PIT ~ U(0,1) (равномерное распределение)

## Методология исследования

### 1. Анализ жирных хвостов (3.dist_bust.R)

**Цель**: Сравнительный анализ распределений с различными типами хвостов

**Методы**:
- Генерация normal, stochastic volatility, mixture распределений
- Tail probability analysis для событий >2σ, >3σ, >4σ, >5σ
- QQ-plots для диагностики нормальности
- Kurtosis и другие моменты для характеристики хвостов

**Результаты**:
- Визуализация различий в хвостах распределений
- Количественная оценка tail risks
- Обоснование необходимости fat-tailed моделей

### 2. R² коррекция для жирных хвостов (4.LmR2BoostingStohastic.R)

**Цель**: Применение методологии Талеба для коррекции R² при fat-tailed residuals

**Методы**:
- **Taleb's exact R² formula**: `R² = a²(α-2)/(a²(α-2) + α)`
- **MLE коррекция**: Учет теоретического `E[ε²] = α/(α-2)`
- **Hill estimator** для оценки параметра α
- Сравнение с standard R² для различных типов residuals

**Результаты**:
- Демонстрация bias в standard R² при fat tails
- Robust оценки для различных типов моделей
- Методики для корректной оценки goodness of fit

### 3. HAR модели волатильности

**Цель**: Прогнозирование волатильности с учетом гетерогенности временных горизонтов

**Модель**:
```
RV(t) = β₀ + β₁RV(t-1) + β₂RV(t-1,t-5) + β₃RV(t-1,t-22) + ε(t)
```

**Компоненты**:
- Daily volatility: RV(t-1)
- Weekly volatility: RV(t-1,t-5)
- Monthly volatility: RV(t-1,t-22)

### 4. Скрытые марковские цепи (HMM)

**Цель**: Моделирование режимов денежно-кредитной политики

**Состояния**:
- S₁: Нормальный режим (низкая волатильность)
- S₂: Кризисный режим (высокая волатильность)
- S₃: Инфляционный режим (агрессивная политика)

**Переходы**:
```
P = [p₁₁ p₁₂ p₁₃]
    [p₂₁ p₂₂ p₂₃]
    [p₃₁ p₃₂ p₃₃]
```

### 5. Gradient Boosting для выбора распределений

**Цель**: Адаптивный выбор оптимального распределения для каждого временного периода

**Алгоритм**:
1. Ensemble из Normal, t-distribution, α-stable, GED
2. Boosting для весов распределений
3. Adaptive distribution selection
4. Cross-validation для robust performance

### 6. Интеграция с моделями ЦБ РФ

#### Расширенное правило Тейлора
Базовое правило дополнено стохастическими компонентами:

```
dr(t) = [α₀ + α₁(π(t) - π*) + α₂(y(t) - y*) + α₃ΔCA(t) + α₄S(t)] dt
      + σ₁ dW(t) + σ₂ dJ(t) + σ₃ dN(t)
```

где:
- `π(t) - π*` — отклонение инфляции от цели
- `y(t) - y*` — разрыв выпуска
- `ΔCA(t)` — динамика цифровых активов
- `S(t)` — санкционные индикаторы
- `dW(t)` — броуновское движение
- `dJ(t)` — α-stable скачки
- `dN(t)` — пуассоновские шоки

#### Нейтральная ставка как стохастический процесс
```
dμ*(t) = κ(E_t[π] - π*) dt + σ_μ dW_μ(t)
```

#### Интеграция данных ЦБ
- Использование моделей ДДКП и ДИП как базовой структуры
- Параметры из `4.CB_models/` для калибровки
- Макроэкономические данные из `3.Data/` для валидации

### 7. Практическое применение

#### Сценарное планирование
- Генерация множественных траекторий процентных ставок
- Stress-testing для экстремальных сценариев
- Оценка tail risks для policy decisions

#### Risk Management
- VaR/CVaR оценки для различных горизонтов
- CRPS и PIT диагностика для model validation
- Tail-sensitive performance metrics

#### Монетарная стратегия
- Adaptive policy rules с учетом режимов
- Robust decision making под неопределенностью
- Integration с существующими моделями ЦБ

### 8. Современные исследования (база для методологии)

#### Tail Risks в центральных банках (2024)

**Fed Research**:
- **Grishchenko & Wilcox (May 2024)**: "Tale About Inflation Tails" - state-space модели для extreme inflation events
- **NY Fed (July 2024)**: ZLB risk analysis - 9% вероятность ZLB на 7-летнем горизонте

**BIS Research**:
- **Heterogeneous agent New Keynesian models** с ZLB constraints
- **Neural network solutions** для сложных DSGE моделей

**St. Louis Fed**:
- **Kozlowski (July 2024)**: Inflation tail risks через financial market data
- Переход от left-tail к right-tail рискам post-pandemic

#### Ограничения α-stable распределений

**Текущее состояние**:
- Ограниченное применение в operational моделях ЦБ
- Фокус на tail risks в inflation expectations, а не в процентных ставках
- Доминирование traditional diffusion/jump-diffusion процессов

**Возможности**:
- Растущий интерес к hybrid monetary systems
- Необходимость модернизации стохастических моделей
- Потенциал для innovative approaches

## Полная интеграция методов

### Принцип интеграции

В отличие от традиционных подходов, где методы работают независимо, наша система обеспечивает **синхронную интеграцию** всех компонентов:

**1. Жирные хвосты влияют на параметры:**
- Эксцесс из анализа хвостов → коррекция α-параметра α-stable распределения
- Вероятность 3σ событий → разделение гауссовской и α-stable компонент
- `alpha_corrected = alpha_estimate * (1 + 0.1 * log(rates_kurtosis / 3))`

**2. HAR волатильность как модулятор:**
- Прогноз HAR → динамическая волатильность в стохастических шоках
- `vol_multiplier = sqrt(current_vol * har_multiplier)`
- Влияние HAR на дисперсию прогнозов измеряется корреляцией

**3. HMM режимы определяют структуру:**
- Обученные переходы → вероятности смены режимов в прогнозах
- Параметры эмиссии → базовые уровни ставок для каждого режима
- Режимы добавляются как факторы в основную модель

**4. Boosting оптимизирует распределения:**
- Выбор распределения → интенсивность α-stable скачков
- `stable_intensity = 1.5 для stable, 1.2 для t, 0.8 для normal`
- Веса распределений влияют на генерацию шоков

**5. Shapley веса определяют важность:**
- Веса переменных → коэффициенты в итоговой модели
- `formula: ruonia_rate ~ I(var1 * weight1) + I(var2 * weight2) + ...`
- Нормализованные веса обеспечивают сбалансированное влияние

### Интеграционные метрики

Система автоматически рассчитывает метрики качества интеграции:

```r
# Влияние HAR на волатильность прогнозов
har_influence = cor(средняя_волатильность_HAR, стандартное_отклонение_прогнозов)

# Стабильность режимов в прогнозах
regime_stability = средняя_доля_уникальных_режимов_по_горизонтам

# Захват хвостовых событий
tail_capture = средняя_вероятность_3σ_событий_в_симуляциях
```

### Добавление новых данных

Система поддерживает динамическое добавление новых переменных:

```r
# Создать файл с новыми данными (обязательно с колонкой date)
new_data <- data.table(
  date = seq(as.Date("2020-01-01"), as.Date("2025-01-01"), by = "month"),
  sanctions_score = runif(61, 0, 100),
  oil_price = runif(61, 50, 150),
  digital_ruble_adoption = runif(61, 0, 1)
)
fwrite(new_data, "3.Data/new_factors.csv")

# Функция автоматически добавит новые переменные как свободные члены
updated_model <- AddNewDataToModel("3.Data/new_factors.csv", final_integrated_model)
```

**Автоматические действия при добавлении данных:**
1. Загрузка и валидация новых переменных
2. Обновление PrepareMainData() с новыми данными
3. Расширение формулы модели: `+ new_var1 + new_var2 + ...`
4. Переобучение модели с сохранением весов Shapley
5. Новые переменные получают равные веса (затем можно переобучить Shapley)

### Ожидаемые результаты интеграции

После запуска `source("1.R/Main.R")` вы получите:

**Консольный вывод:**
```
=== РЕЗУЛЬТАТЫ ПОЛНОЙ ИНТЕГРАЦИИ ВСЕХ МЕТОДОВ ===
1. ЖИРНЫЕ ХВОСТЫ → Эксцесс: 4.23, α-коррекция: 2.85
2. HAR ВОЛАТИЛЬНОСТЬ → R²: 0.72, Влияние: 0.65
3. HMM РЕЖИМЫ → Normal: 60%, Crisis: 25%, Inflationary: 15%
4. GRADIENT BOOSTING → Лучшее распределение: t
5. TALEB R² + SHAPLEY → R²: 0.68, Веса: inflation(0.35), gdp(0.28)...
6. ИНТЕГРАЦИЯ → Захват хвостов: 8.3%
```

### Новые визуализации

#### 1. Интерактивные сети марковских цепей
Система создает интерактивные визуализации переходов между режимами с помощью visNetwork:

```r
# Создание интерактивной сети
markov_network <- CreateMarkovNetworkVisualization(hmm_model)
markov_network
```

**Особенности:**
- Узлы представляют режимы (Normal, Crisis, Inflationary)
- Размер узла зависит от устойчивости режима
- Толщина рёбер отражает вероятность перехода
- Интерактивные подсказки с детальной информацией
- Возможность перетаскивания и масштабирования

#### 2. Улучшенные графики с белым фоном
Все графики переведены на белый фон для лучшей читаемости:

```r
# Сравнительный график моделей
model_comparison_plot <- CreateModelComparisonPlot(
  baseline_forecasts,
  final_integrated_model,
  train_data_with_regimes,
  forecast_dates
)
```

**Улучшения:**
- Белый фон с серой сеткой
- Современная цветовая палитра
- Четкие контрасты для лучшей видимости
- Профессиональное оформление для презентаций

#### 3. Тепловые карты матриц переходов
Визуализация вероятностей смены режимов:

```r
# Тепловая карта переходов
transition_heatmap <- CreateTransitionHeatmap(hmm_model$transition_matrix)
```

**Функции:**
- Цветовая кодировка вероятностей
- Интерактивные подсказки
- Профессиональное оформление
- Адаптация к различным размерам матриц

